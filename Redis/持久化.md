## 持久化

Redis持久化的目的：当Redis崩溃时，可以快速恢复其之前的状态。

Redis的持久化有两种方式：

* RDB（默认）
* AOF

### RDB

RDB(Redis DataBase)机制：fork出一个**子进程**，根据一定的频率将内存中的数据以**<u>快照</u>**的形式保存到**<u>硬盘</u>（`dump.rdb`文件）**中。

![img](https://pic2.zhimg.com/v2-bb6210ee7b6eaa179fef0fe34189e3c1_b.jpg)

### AOF
AOF(Append Only File)：将所有**写入命令**记录下来，临时保存在aof_buf缓冲区中，最后择机写入AOF文件并**<u>刷新</u>**。

>  当两种方式同时开启时，Redis会优先选择AOF进行数据恢复。

![image-20211102142715593](https://raw.githubusercontent.com/cluckl/Pinnned-repo/master/img/20211102142725.png)

#### AOF刷新

AOF刷新：将被OS缓存区缓存的数据写入AOF文件中。

通过设置`appendfsync`参数的值实现：

1. always: 每个事件周期同步刷新一次
2. everysec: 每秒同步刷新一次
3. no: 操作系统自行决定写入时机

#### AOF重写
AOF重写：fork出一个子进程，将其压缩，能够一定程度上防止AOF文件越来越大。
在重写过程中，为了防止出现新的数据（即写入命令），建立了一个AOF重写缓冲区（`aof_rewrite_buf`），将新的数据备份在该区，等重写AOF文件结束之后，再把这个缓冲区中的数据写入到新的AOF文件中。
![image-20211102151744005](https://raw.githubusercontent.com/cluckl/Pinnned-repo/master/img/20211102151746.png)

### RDB与AOF比较

* 安全性：AOF比RDB的更新频率高，AOF文件保存的数据集比RDB文件保存的数据集完整更加。
* 效率：AOF比RDB启动效率低，特别是在数据集较大的情况下。

## 参考资料

* [突然挂了！Redis缓存都在内存中，这下完了！](https://mp.weixin.qq.com/s/uI2Mr_5KC45O7SGRa0-LHw)

  

