[TOC]

# 索引

## 概述

索引：特殊的**查找表**(**lookup tables**)，可以认为是指向表中数据的**指针**，用于快速查找具有**特定列值的行**。

### 优点

* 提高查询速度
* B-Tree索引可以提高生成**有序结果集**的速度
* 唯一索引或者主键索引可以保证数据库中每一行数据的**唯一性**
* 全文索引可以加快**文本**的查询和DML操作的效率

### 缺点

* 索引文件会占用磁盘空间

* 在使用DML时需要维护索引文件，增加了开销


### 索引失效的场景⭐

* 使用`!=`不等于运算
* 使用数学或函数运算
* 使用`like`字句时左边是通配符(`%`)
* mysql分析全表扫描比使用索引快
* 使用联合索引时不符合最左前缀原则

### 索引设计原则⭐

* 查询频次高、数据量大的表
* 数据区分度高的列
* 经常需要排序、分组或联合操作的字段
* 限制索引的数目
* 使用短索引，减少存储空间，提升I/O效率

## 索引分类⭐
### 复合索引

复合索引：包含两个或以上字段的索引叫做**复合索引**（或组合索引）。

在使用该索引时应注意**最左前缀匹配原则**，即查询条件中的字段必须与索引字段从左到右进行匹配。

### 唯一索引

唯一索引：索引列的值是唯一的，允许出现空值。一张表可以创建**任意多个唯一索引**，但一般只建立一个。

**主键**：特殊的**唯一索引**，不允许出现**null值**，一个表最多只能定义一个主键。

### 全文索引

全文索引(Full-text indexes)：用于可以加快**文本**的查询和DML操作

* 只支持[`CHAR`](https://dev.mysql.com/doc/refman/8.0/en/char.html)， [`VARCHAR`](https://dev.mysql.com/doc/refman/8.0/en/char.html)或[`TEXT`](https://dev.mysql.com/doc/refman/8.0/en/blob.html)等类型的列
* 相对于使用`like` + `%`，全文索引的速度更快

> MySQL 5.6 及以后的版本， InnoDB 支持全文索引

### 聚集索引
聚集索引(clustered index)：定义了数据在表中的**物理存储顺序**，因此每个表只能创建**一个**聚集索引。

一般情况下**主键**即为默认的聚集索引。在InnoDB中，如果表没有定义主键，则会选择一个不会出现null值的**唯一索引**代替，如果仍找不到则**隐式定义**一个主键来作为聚集索引。

> InnoDB不支持单独建立聚集索引，必须与主键一致。

#### 聚集索引和非聚集索引的区别

* **使用次数**：每个表只能创建一个聚集索引；但可以创建多个非聚集索引
* **查询效率**：聚集索引一般比非聚集索引要快，因为非聚集索引在不是覆盖索引的情况下需要跳转到聚集索引查找数据，即非聚集索引需要查询两次，聚集索引只需要查询一次

#### 自增ID和UUID作为主键的区别

假设主键使用聚集索引：

* 如果主键是自增ID，新建数据行对应的数据是相邻地存放在磁盘上，写入性能较高
* 如果主键是UUID，频繁的插入会频繁地移动磁盘块，写入性能较低

## 索引实现方式
### Hash索引

Hash索引通过一个散列函数，能够根据key快速找到对应的value。

特点：对单个列查询速度较快，但其不具有顺序结构，对范围查找效率低下，不支持排序，模糊查询，且在重复值较高的时候，因为存在**哈希碰撞**导致性能极低。

### [AVL树](../../DataStructure/AVL%E6%A0%91.md)和[红黑树](../../DataStructure/%E7%BA%A2%E9%BB%91%E6%A0%91.md)
这两种数据结构能够自动调整结构，一定程度避免普通的二叉查找树的极端情况。但AVL树调整节点需要较多的IO次数，降低查找效率；红黑树不能完全避免树的左倾/右倾现象。

<img src="https://pic1.zhimg.com/v2-46e7e44e8ba85e606d68ea9644092d08_r.jpg" alt="img" style="zoom: 25%;" />

### B树和B+树⭐

#### B树

<img src="https://pic1.zhimg.com/v2-7d5e34c698b1e4192ad0ff93c2c897d0_r.jpg" alt="img" style="zoom: 33%;" />

* 较好的查找性能：O（h* logn），其中 h 为树高，n 为每个节点关键词的个数
* 尽可能少的磁盘I/O
* 支持范围查找

#### B+树

<img src="https://pic2.zhimg.com/v2-bda6661499c51dcff63eb12fd4b3795d_r.jpg" alt="img" style="zoom: 33%;" />

* B 树的**非叶子节点**里存的是数据，而 B+树存储的是**索引**，因此一个非叶子节点有更多的子节点，即能存更多的索引，同时使得整个 B+树**高度降低**，减少了**磁盘 IO**。
* B+树的**叶子节点**存放所有的数据，**查询效率更稳定**；同时叶子节点用了链表连接起来，这个链表本身就是有序的，在**范围查找**、**排序查找**和增删时更有效率。

## InnoDB和MyISAM的索引

Mysql 底层数据引擎以插件形式设计，最常见的是Innodb 引擎和 Myisam 引擎。

### InnoDB的索引

Innodb 是**聚集索引**，数据和主键索引在一起，即索引 + 数据 = 整个表数据文件。

<img src="https://segmentfault.com/img/remote/1460000022206427/view" alt="preview" style="zoom: 67%;" />

辅助索引树的叶子节点记录的是主键的值，因此一般情况下需要两次查询。

<img src="https://segmentfault.com/img/remote/1460000022206430" alt="img" style="zoom: 67%;" />

该引擎在牺牲较少查询的性能下节省了巨大的**磁盘空间**。（时间换空间）

### MyISAM的索引
<img src="https://raw.githubusercontent.com/cluckl/Pinnned-repo/master/img/20210506215323.png" alt="image-20210506215323635" style="zoom:80%;" />

MyISAM 用的是**非聚集索引**方式，即数据和索引落在不同的两个文件上。主键索引和辅助索引的叶子节点都是数据文件的地址指针。

### InnoDB和MyISAM索引的区别⭐

|            | InnoDB         | MyISAM                 |
| ---------- | -------------- | ---------------------- |
| 物理存储   | 聚集索引       | 非聚集索引             |
| 并发       | 支持行锁和表锁 | 只支持表锁，不支持行锁 |
| 事务支持   | 事务和MVCC     | 不支持                 |
| 索引支持   | 旧版本不支持   | 支持                   |
| 主键       | 会自动生成主键 | 允许没有主键的表存在   |
| 引用完整性 | 支持外键       | 不支持外键             |



## 索引测试
使用`EXPLAIN SELECT`命令,该命令不会去执行`SELECT`命令，而是会对其使用**优化器**进行分析。
MySQL将以表格的形式把查询的执行过程和用到的索引(如果有的话)等信息列出来。例：
![](../pic/Pasted%20image%2020210320182705.png)
Handler_read_key：代表了一个行被索引值读的次数，很低的值表明增加索引得到的性能改善不高，因为索引并不经常使用。
Handler_read_rnd_next ：表示在数据文件中读下一行的请求数。值高则意味着查询运行低效，并且应该建立索引补救。

## 参考资料

* [The Benefits of Indexing Large MySQL Tables | Guidelines for ...](https://www.drupal.org/docs/7/guidelines-for-sql/the-benefits-of-indexing-large-mysql-tables)
* [MySQL 8.0 Reference Manual :: 15.6.2.4 InnoDB Full-Text Indexes](https://dev.mysql.com/doc/refman/8.0/en/innodb-fulltext-index.html)

* [MySQL索引总结](https://zhuanlan.zhihu.com/p/29118331)
* [SQL CREATE INDEX Statement - W3Schools](https://www.w3schools.com/sql/sql_create_index.asp)
* [深入理解 Mysql 索引底层原理](https://zhuanlan.zhihu.com/p/113917726)
* [通俗易懂 索引、单列索引、复合索引、主键、唯一索引、聚簇索引、非聚簇索引、唯一聚簇索引 的区别与联系](https://zhuanlan.zhihu.com/p/66553466)
* [MyISAM和InnoDB 索引区别- SegmentFault 思否](https://segmentfault.com/a/1190000022206424)
* [MYSQL-MyISAM 和InnoDB 索引的区别(简单介绍) - 华为云](https://www.huaweicloud.com/articles/ee930779389838d6ba734bdd54e97853.html)
