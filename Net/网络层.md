# 网络层
在[传输层](传输层.md)的基础上，提供主机到主机之间的**逻辑通信**服务。

网络层包含有[IP](#IP)，[ICMP](#ICMP)，[ARP](#ARP)等协议。

# IP
IP(Internet Protocol)：提供**无连接**的**packet(包，又称为分组)**通信服务，不能保证分组可靠的、按序到达。

## IP分组结构
![](https://raw.githubusercontent.com/cluckl/Pinnned-repo/master/img/20210424143501.png)
* 版本：4位，表示IP协议版本，通常为0100（v4），若为0110则表示为v6版
* 区分服务：8位，以前称为服务类型，从未使用过。1998年改称区分服务。用于指明要求网络提供的服务，目前主要包括D、T、R等三种，分别代表延迟、吞吐量和可靠性要求。
* 总长度：16位，包括了首部长度和数据长度。
* 标识：16位，数据报计数器，用于区分数据报的唯一标识符。
* 标志：3 位，最高位保留；中间位是不分片（Don‘t Fragment，DF）标志，DF=1则不允许分片。最低位是有更多分片（More Fragment，MF）标志，除最后一个分片MF=0以外外其余都是MF=1。
* 片偏移：13 位，表示分片后，该片在原分组中的相对位置。片偏移以 8 个字节为偏移单位。
* 生存时间：8 位，表示数据报在网络中可通过的路由器数的最大值。若超出最大值，则丢弃数据包，并返回“目标不可达”。
* 协议：8位，指出此数据报使用何种协议。如[ICMP](ICMP.md)协议
* 首部检验和：16位，只检验数据报首部。
* 源地址：32位，发送端主机IP地址。
* 目的地址：32位，接收端主机IP地址。

## 分类IP地址
IP地址被分为五类，分别称为A类、B类、C类、D类和E类：
![](https://raw.githubusercontent.com/cluckl/Pinnned-repo/master/img/20210424143502.png)
A、B和C类地址分别有两个固定长度的字段组成，其中一个字段是网络号（net-id），表示联网主机（或网络设备）所在的网络，另一个字段是主机号（host-id），表示联网主机（或网络设备）本身。**D类和E类地址不区分网络和主机。**
![](https://raw.githubusercontent.com/cluckl/Pinnned-repo/master/img/20210424143503.png)

## 划分子网IP地址
![](https://raw.githubusercontent.com/cluckl/Pinnned-repo/master/img/20210424143504.png)
* 将一个IP类网划分成几个较小的子网（subnet）
* 多个物理网共享同一个IP类网前缀

==即，子网划分就是在32位中借了几位用来表示子网号。==
用==子网掩码==分离网络号和主机号：
![](https://raw.githubusercontent.com/cluckl/Pinnned-repo/master/img/20210424143505.png)

## 特殊地址
* host-id全为“1”的地址：本子网内的**广播地址**
* host-id为零的IP地址表示该**网络本身**

## 保留地址
保留地址：又称为私网地址，各独立网络可以重复使用的IP地址。网络边界路由器（通常就是网关）不会向目标地址为这些保留地址的主机转发IP分组。也就是说，保留地址不会穿越内部网络。==即只在局域网内使用==。
>A类：10.0.0.0 （1个网络）
B类：172.16.0.0—172.31.0.0（16个网络）
C类：192.168.0.0—192.168.255.0（256个网络）
注意：当采用静态或者动态转换时，一个保留地址对应一个公网地址；而采用端口复用的方式，在一个子网中的所有地址都采用一个公网地址。

## CIDR
Classless Inter-Domain Routing
![](https://raw.githubusercontent.com/cluckl/Pinnned-repo/master/img/20210424143506.png)
### 特点
* 斜线记法
* CIDR 地址块
*  聚合->超网(supernetting)
*  最长前缀匹配原则

# ICMP
**ICMP(Internet Control Message Protocol)**：当[IP](#IP)丢包时向传输层报告丢包以及丢包的原因。

* 基于[IP](#IP)
* 需要经过**两次封装**
## 结构
报头：
![](https://raw.githubusercontent.com/cluckl/Pinnned-repo/master/img/20210424143507.png)
数据：
![](https://raw.githubusercontent.com/cluckl/Pinnned-repo/master/img/20210424143508.png)



## 应用

### Ping
 **Ping(Packet InterNet Groper)**：基于ICMP，用来测试两个主机之间的连通性。

过程：源主机向目的主机发送Echo Request，目的主机收到之后进行响应，回复Echo reply。
Ping 会根据**<u>时间</u>**和**<u>成功响应的次数</u>**估算出**<u>数据包往返时间</u>**以及**<u>丢包率</u>**从而推断网络是否通常、运行是否正常等。

注意：PING 是应用层直接使用网络层 ICMP 的例子，它没有通过传输层的 TCP 或UDP。 
### Tracert
Tracert 命令用 IP 生存时间 (TTL) 字段和 ICMP 错误消息来确定从一个主机到网络上其他主机的路由，是实现路由追踪（trace router）的一种手段。

1. 首先tracert送出3个TTL是1的IP 数据包到目的地，当路径上的第一个路由器收到这个数据包时，它将TTL减1，此时TTL等于0.
2. 所以该路由器会将此数据包丢掉，并送回一个**ICMP time exceeded ** 消息（TTL超时消息），里面包括发IP包的源地址，IP包的所有内容及路由器的IP地址
3. tracert 收到这个消息后，便知道这个路由器存在于这个路径上，接着tracert 再送出另一个TTL是2 的数据包，发现第2 个路由器.....以此类推
4. 当数据包到达目的地后，该主机则不会送回 **ICMP time exceeded** 消息
5. 一旦到达目的地，由于tracert通过UDP数据包向不常见端口(30000以上)发送数据包，因此会收到 ICMP port unreachable 消息，故可判断到达目的地。





# ARP
ARP(Address Resolution Protocol)：将IP地址转换成[MAC](数据链路层.md#MAC)地址。

## 以太帧格式
![](https://raw.githubusercontent.com/cluckl/Pinnned-repo/master/img/20210424143509.png)
>硬件类型：如以太网（0x0001）、分组无线网。
协议类型：如网际协议(IP)（0x0800）、IPv6（0x86DD）。
硬件地址长度：每种硬件地址的字节长度，一般为6（以太网）。
协议地址长度：每种协议地址的字节长度，一般为4（IPv4）。
操作码：1为ARP请求，2为ARP应答，3为RARP请求，4为RARP应答。
源硬件地址：n个字节，n由硬件地址长度得到，一般为发送方MAC地址。
源协议地址：m个字节，m由协议地址长度得到，一般为发送方IP地址。
目标硬件地址：n个字节，n由硬件地址长度得到，一般为目标MAC地址。
目标协议地址：m个字节，m由协议地址长度得到，一般为目标IP地址。

## ARP原理
主机里有一个ARP缓存表，表里的IP地址与MAC地址一一对应：
![](https://raw.githubusercontent.com/cluckl/Pinnned-repo/master/img/20210424143510.png)
以主机A向主机B发送数据为例：

1. 如果B主机的IP地址存在于缓存表中，则A主机将对应的MAC地址写入帧发送给B主机。
2. 如果在ARP缓存表中没有找到相对应的IP地址，主机A就会在网络上发送一个广播（ARP request），以询问对方的MAC地址；**只有**主机B接收到这个帧时，才向主机A发出以单播方式的回应（ARP response），并将A的IP和MAC地址保存到B的缓存表里面。

ARP缓存表采用老化机制，在一段时间内如果表中的某一行没有使用，就会被删除，这样可减少缓存表的长度，加快查询速度。并且，如果电脑或者通信设备重启的话，这张表也会清空。

## gratuitous ARP
主机发送ARP查询（广播）自己的IP地址，当**ARP功能被开启**或者**端口初始配置完成**，主机向网络发送免费ARP来查询自己的IP地址确认地址唯一可用。
作用：

1. 查询网络中是否有其他主机使用了IP地址，如果有应答则产生错误消息。
2.  免费ARP可以**更新ARP的缓存**，网络中的其他主机收到该广播则在缓存中更新条目，收到该广播的主机无论是否存在与IP地址相关的条目都会强制更新，如果存在旧条目则会将MAC更新为广播包中的MAC。

## ARP攻击
利用攻击主机收到被攻击主机的广播时，虽然攻击主机不是目标主机，但却欺骗发送主机，将自己的IP改为目标主机的IP，并向被攻击主机发出回应，当回应的频率达到一定要求（能够覆盖真正目标主机发出的回应），便可以完成ARP攻击。